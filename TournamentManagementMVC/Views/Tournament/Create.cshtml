@using Microsoft.AspNetCore.Mvc.Razor
@model TournamentManagementLogic.Model.CreateTournamentModel

@{
    ViewData["Title"] = "Create";
}

<h1>Create Tournament</h1>

<hr />

<form asp-action="Create">
    <div class="row">
        <div class="col-md-4">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="GameName" class="control-label"></label>
                <input asp-for="GameName" class="form-control" />
                <span asp-validation-for="GameName" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Description" class="control-label"></label>
                <textarea asp-for="Description" class="form-control"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-4">
            <div id="teams" class="form-group mb-1">
                <label asp-for="Teams" class="control-label"></label>
                <span asp-validation-for="Teams" class="text-danger"></span>
            </div>
            <div class="form-group mt-2">
                <button class="btn btn-secondary" onclick="addTeam(null)" type="button">Add Team</button>
                <button class="btn btn-secondary" onclick="shuffleTeams()" type="button">Shuffle Teams</button>
            </div>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="form-group mt-2">
                <input type="submit" value="Create Tournament" class="btn btn-primary" />
            </div>
        </div>
    </div>
</form>


<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");

        const int templateIndex = int.MaxValue;
        const int templateTeamNum = int.MaxValue - 1;
    }

    <script type="text/html" id="addTeamTemplate">
        <div id ="team-@(templateIndex)-div" class="input-group mb-1 team-div">
            <label asp-for="Teams[templateIndex].Name" class="input-group-text">@templateTeamNum.</label>
            <input asp-for="Teams[templateIndex].Name" class="form-control" placeholder="Team Name"/>
            <button class="btn btn-danger" onclick="removeTeam(@templateIndex)" type="button">X</button>
            <div class="input-group">
                <span asp-validation-for="Teams[templateIndex].Name" class="text-danger"></span>
            </div>
        </div>
    </script>

    <script type="text/javascript">

        var numOfTeams = -1;

        function addTeam(inputVal) {
            numOfTeams++;

            var template = $('#addTeamTemplate').html();
            template = template.replace(/@templateIndex/g, numOfTeams);
            template = template.replace(/@templateTeamNum/g, numOfTeams + 1);

            $('#teams').append(template);

            if (inputVal != null) {
                $('#team-' + numOfTeams + '-div > input').val(inputVal);
            }

            $('form').data('validator', null);
            $.validator.unobtrusive.parse($('form'));
        };

        function shuffleTeams() {
            var teamDivs = $('.team-div');

            var n = teamDivs.length;

            while (n > 1) {
                var k = Math.floor(Math.random() * n);
                n--;

                var kInput = $(teamDivs[k]).find('input');
                var nInput = $(teamDivs[n]).find('input');

                var temp = kInput.val();

                kInput.val(nInput.val());
                nInput.val(temp);
            }
        }

        function removeTeam(index) {

            $('#team-' + index + '-div').remove();

            refreshTeams();
        }

        function refreshTeams() {
            var teamDivs = $('.team-div');

            var inputValues = [];

            for (let i = 0; i < teamDivs.length; i++) {
                inputValues[i] = $(teamDivs[i]).find('input').val();

                teamDivs[i].remove();
            }

            numOfTeams = -1;

            for (let i = 0; i < inputValues.length; i++) {
                addTeam(inputValues[i]);
            }
        }
    </script>
}
